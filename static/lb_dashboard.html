<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RustProxy Load Balancer</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%23111827'/%3E%3Cpath d='M12 44V20h10c6 0 9 3 9 7.5S28 35 22 35h-4v9z M18 25v6h3.5c2.5 0 3.5-1.2 3.5-3s-1-3-3.5-3z' fill='%2322c55e'/%3E%3Cpath d='M34 44V20h10c6 0 9 3 9 7.5S49 35 44 35h-4v9z M40 25v6h3.5c2.5 0 3.5-1.2 3.5-3s-1-3-3.5-3z' fill='%234ade80'/%3E%3Ccircle cx='52' cy='42' r='6' fill='none' stroke='%2322c55e' stroke-width='2'/%3E%3Cpath d='M52 38v4h4' stroke='%2322c55e' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
    <style>
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(34, 197, 94, 0.5); }
            50% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.8); }
        }
        .active-glow { animation: pulse-glow 2s ease-in-out infinite; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-full">

        <!-- Header -->
        <div class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-green-400">RustProxy Load Balancer</h1>
                <p class="text-gray-400 mt-1" id="subtitle">Initializing...</p>
            </div>
            <div id="health-badge" class="px-3 py-1 rounded-full text-sm font-medium bg-gray-700 text-gray-400">
                Connecting...
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-8 gap-4 mb-8">
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <p class="text-gray-400 text-xs uppercase tracking-wider">Listen</p>
                <p id="listen-addr" class="text-lg font-bold text-white mt-1 truncate">-</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <p class="text-gray-400 text-xs uppercase tracking-wider">Algorithm</p>
                <p id="algorithm" class="text-lg font-bold text-blue-400 mt-1">-</p>
            </div>
            <div id="ss-mode-card" class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <p class="text-gray-400 text-xs uppercase tracking-wider">Mode</p>
                <p id="ss-mode" class="text-lg font-bold text-gray-400 mt-1">Plain TCP</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <p class="text-gray-400 text-xs uppercase tracking-wider">Uptime</p>
                <p id="uptime" class="text-lg font-bold text-white mt-1">-</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <p class="text-gray-400 text-xs uppercase tracking-wider">Active Conns</p>
                <p id="active-conns" class="text-lg font-bold text-green-400 mt-1">0</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <p class="text-gray-400 text-xs uppercase tracking-wider">Traffic TX / RX</p>
                <p id="traffic" class="text-lg font-bold text-white mt-1">0 / 0</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <p class="text-gray-400 text-xs uppercase tracking-wider">Throughput</p>
                <p id="throughput" class="text-lg font-bold text-yellow-400 mt-1">-</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 border border-purple-700 border-l-4">
                <p class="text-gray-400 text-xs uppercase tracking-wider">24h Traffic</p>
                <p id="traffic-24h" class="text-lg font-bold text-purple-400 mt-1">-</p>
            </div>
        </div>

        <!-- Traffic History Chart -->
        <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden mb-8">
            <div class="px-6 py-4 border-b border-gray-700 flex items-center justify-between flex-wrap gap-2">
                <h2 class="text-xl font-bold">Traffic History</h2>
                <div class="flex items-center gap-2">
                    <input type="date" id="history-date" class="bg-gray-700 text-gray-100 text-sm rounded px-3 py-1.5 border border-gray-600 focus:border-purple-500 focus:outline-none">
                    <button onclick="loadHistoryForDate()" class="px-3 py-1.5 text-sm font-medium rounded bg-purple-600 hover:bg-purple-700 text-white transition-colors">Load</button>
                    <button onclick="loadLast24h()" class="px-3 py-1.5 text-sm font-medium rounded bg-gray-600 hover:bg-gray-500 text-white transition-colors">Last 24h</button>
                </div>
            </div>
            <div class="p-4" style="height: 320px;">
                <canvas id="traffic-chart"></canvas>
            </div>
        </div>

        <!-- Backend Table -->
        <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-700 flex items-center justify-between">
                <h2 class="text-xl font-bold">Backends</h2>
                <span id="backend-count" class="text-gray-400 text-sm">0 backends</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-900">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">ID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Address</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Active</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Total Conns</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">TX</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">RX</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Errors</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">HTTP Ping</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Last Check</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody id="backend-tbody" class="divide-y divide-gray-700">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Active Connections Table -->
        <div class="bg-gray-800 rounded-lg border border-green-900 overflow-hidden mt-8">
            <div class="px-6 py-4 border-b border-gray-700 flex items-center justify-between">
                <h2 class="text-xl font-bold text-green-400">Active Connections</h2>
                <span id="active-conn-count" class="text-gray-400 text-sm">0 connections</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-900">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Client IP</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">SS Target</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Backend</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">TX</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">RX</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Duration</th>
                        </tr>
                    </thead>
                    <tbody id="active-conn-tbody" class="divide-y divide-gray-700">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mt-4 text-center text-gray-600 text-xs">
            Auto-refreshing every 2s &mdash; RustProxy Load Balancer Dashboard
        </div>
    </div>

    <script>
        const POLL_INTERVAL = 2000;
        const CHART_INTERVAL = 60000;
        let prevTx = null, prevRx = null, prevTime = null;
        let trafficChart = null;

        function fmtNum(v) { return v >= 10 ? Math.floor(v).toString() : v.toFixed(1); }

        function formatRate(bytesPerSec) {
            if (bytesPerSec >= 1e9) return fmtNum(bytesPerSec / 1e9) + ' GB/s';
            if (bytesPerSec >= 1e6) return fmtNum(bytesPerSec / 1e6) + ' MB/s';
            if (bytesPerSec >= 1e3) return fmtNum(bytesPerSec / 1e3) + ' KB/s';
            return Math.floor(bytesPerSec) + ' B/s';
        }

        function formatBytes(b) {
            if (b === 0) return '0 B';
            const k = 1024;
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(b) / Math.log(k));
            return Math.floor(b / Math.pow(k, i)) + ' ' + units[i];
        }

        function formatUptime(secs) {
            const d = Math.floor(secs / 86400);
            const h = Math.floor((secs % 86400) / 3600);
            const m = Math.floor((secs % 3600) / 60);
            const s = secs % 60;
            if (d > 0) return d + 'd ' + h + 'h ' + m + 'm';
            if (h > 0) return h + 'h ' + m + 'm ' + s + 's';
            if (m > 0) return m + 'm ' + s + 's';
            return s + 's';
        }

        function formatHcStatus(b) {
            switch (b.hc_status) {
                case 1: return '<span class="text-green-400 font-medium">' + b.hc_response_ms + 'ms</span>';
                case 2: return '<span class="text-red-400 font-medium">error</span>';
                case 3: return '<span class="text-yellow-400 font-medium">timeout</span>';
                default: return '<span class="text-gray-500">-</span>';
            }
        }

        function formatLastCheck(epochSecs) {
            if (!epochSecs || epochSecs === 0) return '<span class="text-gray-500">never</span>';
            const ago = Math.floor(Date.now() / 1000) - epochSecs;
            if (ago < 0) return 'just now';
            if (ago < 60) return ago + 's ago';
            if (ago < 3600) return Math.floor(ago / 60) + 'm ago';
            if (ago < 86400) return Math.floor(ago / 3600) + 'h ago';
            return Math.floor(ago / 86400) + 'd ago';
        }

        async function toggleBackend(id, enable) {
            const action = enable ? 'enable' : 'disable';
            try {
                const res = await fetch('/api/backends/' + id + '/' + action, { method: 'POST' });
                const data = await res.json();
                if (!data.ok) alert(data.message);
                await refresh();
            } catch (e) {
                console.error('Toggle failed:', e);
            }
        }

        function renderBackends(backends) {
            const tbody = document.getElementById('backend-tbody');
            tbody.innerHTML = '';
            backends.forEach(b => {
                const hasErrors = b.total_errors > 0;
                const hcFail = !b.enabled && (b.hc_status === 2 || b.hc_status === 3);
                const statusColor = b.enabled
                    ? (hasErrors ? 'bg-yellow-500' : 'bg-green-500')
                    : 'bg-red-500';
                const statusText = b.enabled ? 'UP' : (hcFail ? 'PING FAIL' : 'DISABLED');
                const statusBadge = b.enabled
                    ? (hasErrors
                        ? 'bg-yellow-900 text-yellow-200'
                        : 'bg-green-900 text-green-200')
                    : 'bg-red-900 text-red-200';
                const btnLabel = b.enabled ? 'Disable' : 'Enable';
                const btnClass = b.enabled
                    ? 'bg-red-600 hover:bg-red-700'
                    : 'bg-green-600 hover:bg-green-700';

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-700/50 transition-colors';
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm font-mono">${b.id}</td>
                    <td class="px-4 py-3 text-sm font-mono">${b.addr}</td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center gap-1.5">
                            <span class="inline-block w-2.5 h-2.5 rounded-full ${statusColor} ${b.enabled && !hasErrors ? 'active-glow' : ''}"></span>
                            <span class="px-2 py-0.5 text-xs rounded-full font-medium ${statusBadge}">${statusText}</span>
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-right">${b.active_connections}</td>
                    <td class="px-4 py-3 text-sm text-right">${b.total_connections}</td>
                    <td class="px-4 py-3 text-sm text-right">${formatBytes(b.total_tx_bytes)}</td>
                    <td class="px-4 py-3 text-sm text-right">${formatBytes(b.total_rx_bytes)}</td>
                    <td class="px-4 py-3 text-sm text-right ${hasErrors ? 'text-yellow-400 font-medium' : ''}">${b.total_errors}</td>
                    <td class="px-4 py-3 text-sm text-right">${formatHcStatus(b)}</td>
                    <td class="px-4 py-3 text-sm text-right">${formatLastCheck(b.hc_last_check_epoch)}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="toggleBackend(${b.id}, ${!b.enabled})"
                            class="px-3 py-1 text-xs font-medium rounded text-white ${btnClass} transition-colors">
                            ${btnLabel}
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function formatDuration(secs) {
            if (secs < 60) return secs.toFixed(1) + 's';
            if (secs < 3600) return Math.floor(secs / 60) + 'm ' + Math.floor(secs % 60) + 's';
            return Math.floor(secs / 3600) + 'h ' + Math.floor((secs % 3600) / 60) + 'm';
        }

        function renderActiveConns(conns) {
            const tbody = document.getElementById('active-conn-tbody');
            tbody.innerHTML = '';
            document.getElementById('active-conn-count').textContent =
                conns.length + ' connection' + (conns.length !== 1 ? 's' : '');
            conns.forEach(c => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-green-900/20 transition-colors bg-green-900/10';
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm font-mono">${c.client_addr}</td>
                    <td class="px-4 py-3 text-sm font-mono">${c.ss_target || '<span class="text-gray-500">-</span>'}</td>
                    <td class="px-4 py-3 text-sm font-mono">${c.backend}</td>
                    <td class="px-4 py-3 text-sm text-right">${formatBytes(c.tx_bytes)}</td>
                    <td class="px-4 py-3 text-sm text-right">${formatBytes(c.rx_bytes)}</td>
                    <td class="px-4 py-3 text-sm text-right">${formatDuration(c.duration_secs)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function refreshConnections() {
            try {
                const res = await fetch('/api/connections');
                if (!res.ok) return;
                const data = await res.json();
                renderActiveConns(data.active);
            } catch (e) {
                console.error('Connections refresh failed:', e);
            }
        }

        // --- Traffic History Chart ---

        function initChart() {
            const ctx = document.getElementById('traffic-chart').getContext('2d');
            trafficChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'TX Rate (MB/s)',
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34,197,94,0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 0,
                            borderWidth: 2,
                            data: []
                        },
                        {
                            label: 'RX Rate (MB/s)',
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59,130,246,0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 0,
                            borderWidth: 2,
                            data: []
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { labels: { color: '#9ca3af' } },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    return ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(2) + ' MB/s';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { tooltipFormat: 'yyyy-MM-dd HH:mm' },
                            ticks: { color: '#6b7280', maxTicksLimit: 12 },
                            grid: { color: 'rgba(75,85,99,0.3)' }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Mbps', color: '#9ca3af' },
                            ticks: { color: '#6b7280' },
                            grid: { color: 'rgba(75,85,99,0.3)' }
                        }
                    }
                }
            });
        }

        async function loadTrafficHistory(start, end) {
            try {
                let url = '/api/traffic/history';
                const params = [];
                if (start) params.push('start=' + start);
                if (end) params.push('end=' + end);
                if (params.length) url += '?' + params.join('&');

                const res = await fetch(url);
                if (!res.ok) return;
                const data = await res.json();

                // Update 24h card
                document.getElementById('traffic-24h').textContent =
                    formatBytes(data.total_tx_24h) + ' / ' + formatBytes(data.total_rx_24h);

                // Convert cumulative points to rate (Mbps) via delta
                const txRates = [];
                const rxRates = [];
                const pts = data.points;
                for (let i = 1; i < pts.length; i++) {
                    const dt = pts[i].timestamp - pts[i-1].timestamp;
                    if (dt <= 0) continue;
                    const txDelta = pts[i].tx_bytes - pts[i-1].tx_bytes;
                    const rxDelta = pts[i].rx_bytes - pts[i-1].rx_bytes;
                    const txMBs = txDelta / (dt * 1e6);
                    const rxMBs = rxDelta / (dt * 1e6);
                    const t = new Date(pts[i].timestamp * 1000);
                    txRates.push({ x: t, y: Math.max(0, txMBs) });
                    rxRates.push({ x: t, y: Math.max(0, rxMBs) });
                }

                trafficChart.data.datasets[0].data = txRates;
                trafficChart.data.datasets[1].data = rxRates;
                trafficChart.update('none');
            } catch (e) {
                console.error('Failed to load traffic history:', e);
            }
        }

        function loadHistoryForDate() {
            const dateInput = document.getElementById('history-date');
            if (!dateInput.value) return;
            const d = new Date(dateInput.value);
            const start = Math.floor(d.getTime() / 1000);
            const end = start + 86400;
            loadTrafficHistory(start, end);
        }

        function loadLast24h() {
            const now = Math.floor(Date.now() / 1000);
            loadTrafficHistory(now - 86400, now);
        }

        // --- Main refresh ---

        async function refresh() {
            try {
                const res = await fetch('/api/stats');
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();

                document.getElementById('subtitle').textContent =
                    data.listen_addr + ' \u2014 ' + data.algorithm + ' \u2014 ' + data.backends.length + ' backends';
                document.getElementById('listen-addr').textContent = data.listen_addr;
                document.getElementById('algorithm').textContent = data.algorithm;
                document.getElementById('uptime').textContent = formatUptime(data.uptime_secs);
                document.getElementById('active-conns').textContent =
                    data.active_connections.toLocaleString() + ' / ' + data.max_connections.toLocaleString();
                document.getElementById('traffic').textContent =
                    formatBytes(data.total_tx_bytes) + ' / ' + formatBytes(data.total_rx_bytes);

                const now = Date.now();
                if (prevTx !== null && prevTime !== null) {
                    const dtSec = (now - prevTime) / 1000;
                    if (dtSec > 0) {
                        const txRate = (data.total_tx_bytes - prevTx) / dtSec;
                        const rxRate = (data.total_rx_bytes - prevRx) / dtSec;
                        document.getElementById('throughput').textContent =
                            formatRate(txRate) + ' / ' + formatRate(rxRate);
                    }
                }
                prevTx = data.total_tx_bytes;
                prevRx = data.total_rx_bytes;
                prevTime = now;

                document.getElementById('backend-count').textContent =
                    data.backends.length + ' backend' + (data.backends.length !== 1 ? 's' : '');

                const badge = document.getElementById('health-badge');
                badge.textContent = 'Healthy';
                badge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-green-900 text-green-200';

                // SS mode badge
                const ssCard = document.getElementById('ss-mode-card');
                const ssLabel = document.getElementById('ss-mode');
                if (data.ss_mode) {
                    let ssText = 'SS: ' + data.ss_method;
                    if (data.ss_listen_port) {
                        ssText += ' @ ' + data.ss_listen_port;
                    }
                    ssLabel.textContent = ssText;
                    ssLabel.className = 'text-lg font-bold text-purple-400 mt-1';
                    ssCard.className = 'bg-gray-800 rounded-lg p-4 border border-purple-700 border-l-4';
                } else {
                    ssLabel.textContent = 'Plain TCP';
                    ssLabel.className = 'text-lg font-bold text-gray-400 mt-1';
                    ssCard.className = 'bg-gray-800 rounded-lg p-4 border border-gray-700';
                }

                renderBackends(data.backends);
            } catch (e) {
                console.error('Refresh failed:', e);
                const badge = document.getElementById('health-badge');
                badge.textContent = 'Error';
                badge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-red-900 text-red-200';
            }
        }

        // Initialize
        initChart();
        refresh();
        refreshConnections();
        loadLast24h();
        setInterval(refresh, POLL_INTERVAL);
        setInterval(refreshConnections, POLL_INTERVAL);
        setInterval(loadLast24h, CHART_INTERVAL);
    </script>
</body>
</html>
